@using LanWatcher.Models
@using LanWatcher.Services

<div class="scan-controls">
    <div class="control-group">
        <label>IP Range</label>
        <div class="ip-input-group">
            <input type="text" @bind="Options.IpRange" @bind:after="OnIpRangeChanged" class="ip-range-input" placeholder="e.g. 192.168.1" disabled="@IsScanning" />
            <span class="ip-separator">.</span>
            <input type="number" @bind="Options.StartAddress" min="1" max="254" class="ip-number-input" disabled="@IsScanning" />
            <span class="ip-separator">-</span>
            <input type="number" @bind="Options.EndAddress" min="1" max="254" class="ip-number-input" disabled="@IsScanning" />
        </div>
        <small class="help-text">@GetScanScopeHint()</small>
    </div>

    <div class="control-group">
        <label>Scan Type</label>
        <div class="toggle-group">
            <button class="toggle-btn @(Options.QuickScan ? "active" : "")" 
                    @onclick="() => Options.QuickScan = true" 
                    disabled="@IsScanning">
                ‚ö° Quick Scan
            </button>
            <button class="toggle-btn @(!Options.QuickScan ? "active" : "")" 
                    @onclick="() => Options.QuickScan = false"
                    disabled="@IsScanning">
                üîç Deep Scan
            </button>
        </div>
    </div>

    <div class="control-group">
        <label>Options</label>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" @bind="Options.ScanPorts" disabled="@IsScanning" />
                Scan Ports
            </label>
        </div>
    </div>

    <div class="control-group">
        <label>Performance</label>
        <div class="slider-group">
            <span>Parallel Scans: @Options.MaxParallelScans</span>
            <input type="range" min="10" max="100" @bind="Options.MaxParallelScans" disabled="@IsScanning" />
        </div>
        <div class="slider-group">
            <span>Ping Timeout: @Options.PingTimeout ms</span>
            <input type="range" min="100" max="3000" step="100" @bind="Options.PingTimeout" disabled="@IsScanning" />
        </div>
    </div>

    <div class="control-group action-group">
        @if (IsScanning)
        {
            <button class="btn btn-danger" @onclick="OnStopClicked">
                ‚èπ Stop Scan
            </button>
        }
        else
        {
            <button class="btn btn-primary" @onclick="OnStartClicked">
                üöÄ Start Scan
            </button>
            @if (HasKnownDevices)
            {
                <button class="btn btn-secondary" @onclick="OnRefreshClicked" title="Quick refresh of previously discovered devices">
                    üîÑ Refresh Known
                </button>
            }
        }
    </div>
</div>

@code {
    [Parameter] public ScanOptions Options { get; set; } = new();
    [Parameter] public bool IsScanning { get; set; }
    [Parameter] public bool HasKnownDevices { get; set; }
    [Parameter] public EventCallback OnStartScan { get; set; }
    [Parameter] public EventCallback OnStopScan { get; set; }
    [Parameter] public EventCallback OnRefreshKnown { get; set; }

    private async Task OnRefreshClicked()
    {
        await OnRefreshKnown.InvokeAsync();
    }

    private void OnIpRangeChanged()
    {
        // Trigger a re-render to update the scope hint
        StateHasChanged();
    }

    private string GetScanScopeHint()
    {
        var input = Options.IpRange?.TrimEnd('.') ?? "";
        var parts = input.Split('.').Where(p => int.TryParse(p, out int v) && v >= 0 && v <= 255).ToArray();
        
        return parts.Length switch
        {
            0 or 1 => "‚ö†Ô∏è Enter at least 2 octets (e.g. 192.168)",
            2 => $"üåê Broad scan: {parts[0]}.{parts[1]}.0-255.{Options.StartAddress}-{Options.EndAddress} ({256 * (Options.EndAddress - Options.StartAddress + 1):N0} IPs)",
            _ => $"üìç Subnet scan: {parts[0]}.{parts[1]}.{parts[2]}.{Options.StartAddress}-{Options.EndAddress} ({Options.EndAddress - Options.StartAddress + 1} IPs)"
        };
    }

    private async Task OnStartClicked()
    {
        await OnStartScan.InvokeAsync();
    }

    private async Task OnStopClicked()
    {
        await OnStopScan.InvokeAsync();
    }
}
