@using LanWatcher.Models
@using LanWatcher.Services

<div class="device-card @(IsSelected ? "selected" : "") @GetRiskClass()" style="border-left: 4px solid @Device.DeviceColor" @onclick="OnCardClick">
    <div class="device-header">
        <span class="device-icon">@Device.DeviceIcon</span>
        <div class="device-info">
            <h4 class="device-ip">@Device.IpAddress</h4>
            <span class="device-hostname">@Device.HostName</span>
            @if (!string.IsNullOrEmpty(Device.NetBiosName))
            {
                <span class="device-netbios" title="NetBIOS Name">(@Device.NetBiosName)</span>
            }
        </div>
        <div class="device-status">
            <span class="status-indicator @(Device.IsOnline ? "online" : "offline")"></span>
            <span class="response-time">@Device.ResponseTime ms</span>
        </div>
    </div>
    
    <div class="device-badges">
        <div class="device-type-badge" style="background-color: @Device.DeviceColor">
            @Device.DeviceType
        </div>
        @if (Device.RiskLevel != RiskLevel.Unknown)
        {
            <div class="risk-badge" style="background-color: @Device.RiskColor" title="Risk Score: @Device.RiskScore">
                @Device.RiskIcon @Device.RiskLevel
            </div>
        }
    </div>

    <div class="device-details">
        <div class="detail-row">
            <span class="detail-label">MAC:</span>
            <span class="detail-value mac-address">@Device.MacAddress</span>
        </div>
        @if (Device.Manufacturer != "Unknown")
        {
            <div class="detail-row">
                <span class="detail-label">Vendor:</span>
                <span class="detail-value manufacturer">@Device.Manufacturer</span>
            </div>
        }
        @if (Device.OperatingSystem != "Unknown")
        {
            <div class="detail-row">
                <span class="detail-label">OS:</span>
                <span class="detail-value os">@Device.OperatingSystem</span>
                @if (Device.Ttl > 0)
                {
                    <span class="ttl-info" title="TTL from ping response">(TTL: @Device.Ttl)</span>
                }
            </div>
        }
        @if (Device.ConnectionType != "Unknown")
        {
            <div class="detail-row">
                <span class="detail-label">Connection:</span>
                <span class="detail-value connection-type @Device.ConnectionType.ToLower()">
                    @GetConnectionIcon() @Device.ConnectionType
                </span>
            </div>
        }
        <div class="detail-row">
            <span class="detail-label">Uptime:</span>
            <span class="detail-value uptime-trend">@Device.UptimeTrend</span>
        </div>
    </div>

    @if (Device.OpenPorts.Any())
    {
        <div class="ports-section">
            <h5>Open Ports (@Device.OpenPorts.Count)</h5>
            <div class="ports-list">
                @foreach (var port in Device.OpenPorts.Take(ShowAllPorts ? Device.OpenPorts.Count : 5))
                {
                    <div class="port-badge @GetPortRiskClass(port.Port)" title="@port.ServiceName">
                        <span class="port-number">@port.Port</span>
                        <span class="port-service">@port.ServiceName</span>
                        @if (!string.IsNullOrEmpty(port.Banner))
                        {
                            <span class="port-banner" title="@port.Banner">üìã</span>
                        }
                    </div>
                }
                @if (Device.OpenPorts.Count > 5 && !ShowAllPorts)
                {
                    <button class="show-more-btn" @onclick="ToggleShowAllPorts" @onclick:stopPropagation="true">
                        +@(Device.OpenPorts.Count - 5) more
                    </button>
                }
            </div>
        </div>
    }

    <div class="device-footer">
        <div class="device-timestamps">
            <span class="last-seen" title="Last seen">üïê @Device.LastSeen.ToString("MM/dd HH:mm")</span>
            <span class="first-discovered" title="First discovered">üìÖ @Device.FirstDiscovered.ToString("MM/dd")</span>
            <span class="discovery-count" title="Times discovered">üîÑ @Device.DiscoveryCount</span>
        </div>
    </div>
</div>

@code {
    [Parameter] public NetworkDevice Device { get; set; } = default!;
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public EventCallback<NetworkDevice> OnSelected { get; set; }

    private bool ShowAllPorts { get; set; }

    private async Task OnCardClick()
    {
        await OnSelected.InvokeAsync(Device);
    }

    private void ToggleShowAllPorts()
    {
        ShowAllPorts = !ShowAllPorts;
    }

    private string GetRiskClass()
    {
        return Device.RiskLevel switch
        {
            RiskLevel.Critical => "risk-critical",
            RiskLevel.High => "risk-high",
            RiskLevel.Medium => "risk-medium",
            RiskLevel.Low => "risk-low",
            _ => ""
        };
    }

    private string GetConnectionIcon()
    {
        return Device.ConnectionType switch
        {
            "WiFi" => "üì∂",
            "Ethernet" => "üîå",
            "Virtual" => "üíª",
            _ => "‚ùì"
        };
    }

    private string GetPortRiskClass(int port)
    {
        // High risk ports
        var highRisk = new[] { 23, 21, 3389, 5900, 5901, 445, 139, 135 };
        var mediumRisk = new[] { 22, 1433, 3306, 5432, 27017, 8080 };
        
        if (highRisk.Contains(port)) return "port-high-risk";
        if (mediumRisk.Contains(port)) return "port-medium-risk";
        return "";
    }
}
