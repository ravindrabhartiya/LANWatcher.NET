@page "/"
@using LanWatcher.Models
@using LanWatcher.Services
@rendermode InteractiveServer
@inject IScanService ScanService
@inject IDeviceRepository DeviceRepository
@implements IDisposable

<PageTitle>LAN Guardian</PageTitle>

<div class="scanner-container">
    <header class="scanner-header">
        <div class="header-content">
            <h1>🛡️ LAN Guardian</h1>
            <p class="subtitle">Network Presence & Security Auditor</p>
        </div>
        <div class="header-info">
            <span class="network-info">📡 Scanning: @GetScanRangeDisplay()</span>
        </div>
    </header>

    <div class="scanner-layout">
        <aside class="sidebar">
            <ScanControls Options="@ScanService.Options"
                         IsScanning="@ScanService.IsScanning"
                         HasKnownDevices="@(_devices.Count > 0)"
                         OnStartScan="StartScan"
                         OnStopScan="StopScan"
                         OnRefreshKnown="RefreshKnownDevices" />

            <ProgressPanel Progress="@_progress" />
        </aside>

        <main class="main-content">
            <StatsDashboard Devices="@_devices" 
                           ActiveFilter="@_activeFilter"
                           OnFilterChanged="HandleFilterChanged" />
            
            <NetworkMap Devices="@FilteredDevices" />
        </main>
    </div>
</div>

@code {
    private List<NetworkDevice> _devices = new();
    private ScanProgress _progress = new();
    private string _activeFilter = "all";

    private List<NetworkDevice> FilteredDevices => _activeFilter switch
    {
        "online" => _devices.Where(d => d.IsOnline).ToList(),
        "risks" => _devices.Where(d => d.RiskLevel == RiskLevel.High || d.RiskLevel == RiskLevel.Critical).ToList(),
        "webservers" => _devices.Where(d => d.DeviceType == DeviceType.WebServer).ToList(),
        "printers" => _devices.Where(d => d.DeviceType == DeviceType.Printer).ToList(),
        "cameras" => _devices.Where(d => d.DeviceType == DeviceType.Camera).ToList(),
        "smart" => _devices.Where(d => d.DeviceType == DeviceType.SmartHome || d.DeviceType == DeviceType.SmartTV).ToList(),
        "unknown" => _devices.Where(d => d.DeviceType == DeviceType.Unknown).ToList(),
        _ => _devices
    };

    protected override void OnInitialized()
    {
        ScanService.OnProgressChanged += HandleProgressChanged;
        ScanService.OnDeviceFound += HandleDeviceFound;
        ScanService.OnScanComplete += HandleScanComplete;
        DeviceRepository.OnDevicesChanged += HandleDevicesChanged;
        
        // Load previously discovered devices immediately
        _devices = ScanService.Devices;
    }

    private async Task StartScan()
    {
        // Don't clear - we want to show existing devices and update them
        await ScanService.StartScanAsync();
    }

    private async Task RefreshKnownDevices()
    {
        await ScanService.RefreshKnownDevicesAsync();
    }

    private void StopScan()
    {
        ScanService.StopScan();
    }

    private void HandleProgressChanged(object? sender, ScanProgress progress)
    {
        _progress = progress;
        InvokeAsync(StateHasChanged);
    }

    private void HandleDeviceFound(object? sender, NetworkDevice device)
    {
        _devices = ScanService.Devices;
        InvokeAsync(StateHasChanged);
    }

    private void HandleScanComplete(object? sender, List<NetworkDevice> devices)
    {
        _devices = ScanService.Devices;
        InvokeAsync(StateHasChanged);
    }

    private void HandleDevicesChanged(object? sender, List<NetworkDevice> devices)
    {
        _devices = devices;
        InvokeAsync(StateHasChanged);
    }

    private void HandleFilterChanged(string filter)
    {
        _activeFilter = filter;
        StateHasChanged();
    }

    private string GetScanRangeDisplay()
    {
        var input = ScanService.Options.IpRange?.TrimEnd('.') ?? "";
        var parts = input.Split('.').Where(p => int.TryParse(p, out int v) && v >= 0 && v <= 255).ToArray();
        
        return parts.Length switch
        {
            2 => $"{parts[0]}.{parts[1]}.*.*",
            3 => $"{parts[0]}.{parts[1]}.{parts[2]}.*",
            _ => $"{input}.*"
        };
    }

    public void Dispose()
    {
        ScanService.OnProgressChanged -= HandleProgressChanged;
        ScanService.OnDeviceFound -= HandleDeviceFound;
        ScanService.OnScanComplete -= HandleScanComplete;
        DeviceRepository.OnDevicesChanged -= HandleDevicesChanged;
    }
}
